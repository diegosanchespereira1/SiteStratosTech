version: "3.8"

services:
  web:
    # Em Swarm Stack o Portainer ignora `build:`. Use uma imagem publicada em um registry.
    # Troque para o seu registry, ex.:
    # image: ghcr.io/sua-org/sitestratostech:latest
    image: sitestratostech:latest

    ports:
      - target: 5173
        published: 80
        protocol: tcp
        mode: ingress

    environment:
      PORT: "5173"
      HOST: "0.0.0.0"

      NEXT_PUBLIC_SUPABASE_URL: ${NEXT_PUBLIC_SUPABASE_URL:-}
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${NEXT_PUBLIC_SUPABASE_ANON_KEY:-}
      VITE_SUPABASE_URL: ${VITE_SUPABASE_URL:-}
      VITE_SUPABASE_PUBLISHABLE_KEY: ${VITE_SUPABASE_PUBLISHABLE_KEY:-}

      SUPABASE_URL: ${SUPABASE_URL:-}
      SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY:-}
      SUPABASE_TABLE: ${SUPABASE_TABLE:-registrations}

    volumes:
      - sitestratostech-data:/app/data

    networks:
      - sitestratostech-network

    healthcheck:
      test:
        [
          "CMD-SHELL",
          "node -e \"fetch('http://127.0.0.1:'+(process.env.PORT||'5173')+'/health').then(r=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))\"",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

    deploy:
      replicas: 1
      restart_policy:
        condition: any
      update_config:
        order: start-first
        parallelism: 1

networks:
  sitestratostech-network:
    driver: overlay
    attachable: true

volumes:
  sitestratostech-data:

