version: "3.8"

services:
  web:
    image: polygonuser/sitestratostech:developer
    environment:
      PORT: "5173"
      HOST: "0.0.0.0"

      NEXT_PUBLIC_SUPABASE_URL: ${NEXT_PUBLIC_SUPABASE_URL:-}
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${NEXT_PUBLIC_SUPABASE_ANON_KEY:-}
      VITE_SUPABASE_URL: ${VITE_SUPABASE_URL:-}
      VITE_SUPABASE_PUBLISHABLE_KEY: ${VITE_SUPABASE_PUBLISHABLE_KEY:-}

      SUPABASE_URL: ${SUPABASE_URL:-}
      SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY:-}
      SUPABASE_TABLE: ${SUPABASE_TABLE:-registrations}

    volumes:
      - sitestratostech-data:/app/data

    networks:
      - PolygonNetwork

    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5173/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints: []
      resources:
        limits:
          cpus: "1"
          memory: 512M
        reservations:
          cpus: "0.25"
          memory: 128M
      labels:
        - traefik.enable=true
        - traefik.http.routers.sitestratostech.rule=Host(`www.stratostech.com.br`)
        - traefik.http.routers.sitestratostech.entrypoints=web,websecure
        - traefik.http.routers.sitestratostech.priority=1
        - traefik.http.routers.sitestratostech.tls=true
        - traefik.http.routers.sitestratostech.tls.certresolver=letsencryptresolver
        - traefik.http.services.sitestratostech.loadbalancer.server.port=5173
        - traefik.http.services.sitestratostech.loadbalancer.passHostHeader=1
        # Redirect HTTP to HTTPS
        - traefik.http.routers.sitestratostech-http.rule=Host(`www.stratostech.com.br`)
        - traefik.http.routers.sitestratostech-http.entrypoints=web
        - traefik.http.routers.sitestratostech-http.middlewares=sitestratostech-redirect
        - traefik.http.middlewares.sitestratostech-redirect.redirectscheme.scheme=https
        - traefik.http.middlewares.sitestratostech-redirect.redirectscheme.permanent=true

networks:
  PolygonNetwork:
    external: true
    name: PolygonNetwork

volumes:
  sitestratostech-data:

