version: "3.8"

services:
  web:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        VITE_SUPABASE_URL: ${VITE_SUPABASE_URL}
        VITE_SUPABASE_PUBLISHABLE_KEY: ${VITE_SUPABASE_PUBLISHABLE_KEY}
    image: sitestratostech:latest
    container_name: sitestratostech-web
    ports:
      # O app (Node) escuta em 5173 dentro do container; publicamos no 80 do host.
      - "80:5173"
      # Para HTTPS (443), use um reverse proxy (Traefik/Nginx) na frente.
    restart: unless-stopped
    environment:
      PORT: "5173"
      HOST: "0.0.0.0"

      # VariÃ¡veis do seu framework (Vite/Next). O server.mjs aceita ambas.
      NEXT_PUBLIC_SUPABASE_URL: ${NEXT_PUBLIC_SUPABASE_URL:-}
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${NEXT_PUBLIC_SUPABASE_ANON_KEY:-}
      VITE_SUPABASE_URL: ${VITE_SUPABASE_URL:-}
      VITE_SUPABASE_PUBLISHABLE_KEY: ${VITE_SUPABASE_PUBLISHABLE_KEY:-}

      # Alternativas diretas
      SUPABASE_URL: ${SUPABASE_URL:-}
      SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY:-}
      SUPABASE_TABLE: ${SUPABASE_TABLE:-registrations}

      # Mantido para compatibilidade com seu stack (nao usado aqui)
      NGINX_HOST: ${NGINX_HOST:-localhost}
    networks:
      - sitestratostech-network
    volumes:
      - sitestratostech-data:/app/data
    healthcheck:
      # Sem depender de curl/wget dentro do container.
      test:
        [
          "CMD-SHELL",
          "node -e \"fetch('http://127.0.0.1:'+(process.env.PORT||'5173')+'/health').then(r=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))\"",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

networks:
  sitestratostech-network:
    driver: bridge

volumes:
  sitestratostech-data:

